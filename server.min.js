const express=require("express"),path=require("path"),slug=require("slug"),multer=require("multer"),bcrypt=require("bcryptjs"),session=require("express-session"),dotenv=require("dotenv").config(),app=express(),PORT=3e3,mongoose=require("mongoose"),engine=require("express-handlebars")["engine"],ObjectId=mongoose.Types["ObjectId"],passport=require("passport"),LocalStrategy=require("passport-local").Strategy,storage=(app.engine("handlebars",engine()),app.set("view engine","handlebars"),app.set("views","./views"),app.use(express.static("static")),app.use(express.urlencoded({extended:!0})),multer.diskStorage({destination:(e,r,o)=>{o(null,"static/upload/")},filename:(e,r,o)=>{console.log(r),o(null,Date.now()+path.extname(r.originalname))}})),upload=multer({storage:storage}),userSchema=new mongoose.Schema({naam:String,email:String,leeftijd:Number,gebruikersnaam:String,wachtwoord:String,googleId:String,voorkeuren:{energielevel:String,leefstijl:String,grootte:String,slaapritme:String},wishlist:[{type:ObjectId,ref:"Product"}]}),User=(userSchema.pre("save",async function(r){try{if(!this.isModified("wachtwoord"))return r();var e=await bcrypt.genSalt(10),o=await bcrypt.hash(this.wachtwoord,e);this.wachtwoord=o,r()}catch(e){r(e)}}),mongoose.model("User",userSchema,"users")),productShema=new mongoose.Schema({naam:String,soort:String,leeftijd:Number,img:String,beschrijving:String,eigenschappen:{activiteit:String,leefstijl:String,grootte:String,dag:String}}),Product=mongoose.model("Product",productShema,"products"),addProduct=(app.use(session({secret:process.env.SESSION_SECRET,resave:!1,saveUninitialized:!1,cookie:{maxAge:9e5}})),mongoose.connect(process.env.DB_CONNECTION_STRING,{useNewUrlParser:!0,useUnifiedTopology:!0}).then(()=>{console.log("Verbonden met de database")}),app.get("/admin-login",async(e,r)=>{var o=e.session.error,e=(e.session.error="",e.session.loggedIn?e.session.gebruikersnaam:"");r.render("admin-login",{error:o,gebruikersnaam:e})}),app.get("/login",async(e,r)=>{var o=e.session.error,e=(e.session.error="",e.session.loggedIn?e.session.gebruikersnaam:"");r.render("login",{error:o,gebruikersnaam:e})}),app.get("/signUp",async(e,r)=>{e.session.loggedIn?r.redirect("/products"):r.render("signUp")}),app.post("/admin-login",(e,r)=>{var{gebruikersnaam:o,wachtwoord:s}=e.body,a=process.env.ADMIN_USERNAME,n=process.env.ADMIN_PASSWORD;console.log("Login username:",o),o===a&&s===n?(console.log("Admin login successful"),e.session.loggedIn=!0,e.session.gebruikersnaam=o,e.session.save(()=>{console.log("Session saved"),r.redirect("/producten-overzicht")})):(console.log("Admin login failed"),e.session.error="Gebruikersnaam of wachtwoord ongeldig",r.redirect("/admin-login"))}),app.post("/admin-logout",(e,r)=>{e.session.destroy(),r.redirect("/admin-login")}),app.post("/login",(o,s)=>{const{gebruikersnaam:a,wachtwoord:r}=o.body;console.log("Login username:",a),User.findOne({gebruikersnaam:a}).then(e=>{e?(console.log("User found:",e),bcrypt.compare(r,e.wachtwoord,(e,r)=>{console.log(r),r?(console.log("Password matched"),o.session.loggedIn=!0,o.session.gebruikersnaam=a,o.session.save(()=>{console.log("Session saved"),s.redirect("/products")})):(console.log("Password did not match"),o.session.error="Gebruikersnaam of wachtwoord ongeldig",s.redirect("/login"))})):(console.log("User not found"),o.session.error="Gebruikersnaam of wachtwoord ongeldig",s.redirect("/login"))}).catch(e=>{console.error("Error gebruiker niet gevonden:",e),o.session.error="Inloggen onsuccesvol",s.redirect("/login")})}),app.post("/logout",(e,r)=>{e.session.destroy(),r.redirect("/login")}),app.post("/signUp",(r,o)=>{const{gebruikersnaam:s,wachtwoord:a,wachtwoordBevestigen:e,naam:n,email:t,leeftijd:i}=r.body;console.log(s),console.log("post request werkt"),s?a!==e?(r.session.error="Wachtwoorden komen niet overeen",o.render("signUp",{error:r.session.error})):User.findOne({$or:[{gebruikersnaam:s},{email:t}]}).then(e=>{return e?(r.session.error="Gebruikersnaam of email is al in gebruik",o.render("signUp",{error:r.session.error}),Promise.reject("Duplicate user")):new User({naam:n,email:t,leeftijd:i,gebruikersnaam:s,wachtwoord:a}).save()}).then(()=>{console.log("new user"),r.session.loggedIn=!0,r.session.gebruikersnaam=s,r.session.save(()=>{o.redirect("/products")})}).catch(e=>{"Duplicate user"!==e&&(console.error("Error gebruiker aanmaken:",e),r.session.error="Gebruiker niet kunnen registreren",o.render("signUp",{error:r.session.error}))}):(r.session.error="Vul een gebruikersnaam in",o.redirect("/signup"))}),app.get("/voorkeuren",async(e,r)=>{r.render("voorkeuren")}),app.get("/products",async(e,r)=>{try{var o,s,a,n,t,i,l=e.session["gebruikersnaam"],c=await User.findOne({gebruikersnaam:l});c?({energielevel:o,leefstijl:s,grootte:a,slaapritme:n}=c.voorkeuren,console.log("Ingelogde gebruiker:",l),console.log("Energielevel:",o),console.log("Leefstijl:",s),console.log("Grootte:",a),console.log("Slaapritme:",n),t={$or:[{"eigenschappen.energielevel":o},{"eigenschappen.leefstijl":s},{"eigenschappen.grootte":a},{"eigenschappen.slaapritme":n}]},i=await Product.find(t),r.render("products",{product:i.map(e=>e.toJSON())})):(console.log("Gebruiker niet gevonden"),r.render("gebruiker-niet-gevonden"))}catch(e){console.error(e),r.status(500).send("An error occurred. Please try again later.")}finally{console.log("got all products for normal user")}}),app.get("/producten-overzicht",async(e,r)=>{try{var o=await Product.find({});r.render("admin-overzicht",{product:o.map(e=>e.toJSON())})}catch(e){console.log(e)}finally{console.log("got all products for admin")}}),async(i,l)=>{try{let{naam:e,soort:r,beschrijving:o,activiteit:s,leefstijl:a,grootte:n,dag:t}=i.body;e=e.charAt(0).toUpperCase()+e.slice(1),r=r.charAt(0).toUpperCase()+r.slice(1),o=o.charAt(0).toUpperCase()+o.slice(1),s=s.charAt(0).toUpperCase()+s.slice(1),a=a.charAt(0).toUpperCase()+a.slice(1),n=n.charAt(0).toUpperCase()+n.slice(1),t=t.charAt(0).toUpperCase()+t.slice(1);var c=new Product({naam:e.replace(/[^a-zA-Z]/g,""),soort:r.replace(/[^a-zA-Z]/g,""),leeftijd:i.body.leeftijd,img:i.file?i.file.filename:null,beschrijving:o.replace("<",""),eigenschappen:{activiteit:s.replace(/[^a-zA-Z]/g,""),leefstijl:a.replace(/[^a-zA-Z]/g,""),grootte:n.replace(/[^a-zA-Z]/g,""),dag:t.replace(/[^a-zA-Z]/g,"")}});c.save(),console.log("added:",c),setTimeout(()=>{l.redirect("/producten-overzicht")},1e3)}catch(e){console.log(e)}finally{console.log("finally")}}),changeProduct=async(c,g)=>{try{let{naam:e,leeftijd:r,soort:o,beschrijving:s,id:a,activiteit:n,leefstijl:t,grootte:i,dag:l}=c.body;var d={};e=e&&e.charAt(0).toUpperCase()+e.slice(1),o=o&&o.charAt(0).toUpperCase()+o.slice(1),s=s&&s.charAt(0).toUpperCase()+s.slice(1),n=n&&n.charAt(0).toUpperCase()+n.slice(1),t=t&&t.charAt(0).toUpperCase()+t.slice(1),i=i&&i.charAt(0).toUpperCase()+i.slice(1),l=l&&l.charAt(0).toUpperCase()+l.slice(1),e&&(d.naam=e.replace(/[^a-zA-Z]/g,"")),r&&(d.leeftijd=r),o&&(d.soort=o.replace(/[^a-zA-Z]/g,"")),s&&(d.beschrijving=s.replace("<","")),c.file&&(d.img=c.file.filename),await Product.findOneAndUpdate({_id:a},d).then(()=>console.log("Object updated successfully.")),n&&await Product.findOneAndUpdate({_id:a},{"eigenschappen.activiteit":n.replace(/[^a-zA-Z]/g,"")}),t&&await Product.findOneAndUpdate({_id:a},{"eigenschappen.leefstijl":t.replace(/[^a-zA-Z]/g,"")}),i&&await Product.findOneAndUpdate({_id:a},{"eigenschappen.grootte":i.replace(/[^a-zA-Z]/g,"")}),l&&await Product.findOneAndUpdate({_id:a},{"eigenschappen.dag":l.replace(/[^a-zA-Z]/g,"")}),setTimeout(()=>{g.redirect("/producten-overzicht")},1e3)}catch(e){console.log(e)}finally{console.log("finally")}},GoogleStrategy=(app.post("/producten-overzicht/add",upload.single("image"),addProduct),app.post("/producten-overzicht/change",upload.single("image"),changeProduct),app.get("/producten-overzicht/aanpassen/:id",async(e,r)=>{try{var o=await Product.findById(e.params.id),s=[];s.push(o),r.render("admin-aanpassen",{product:s.map(e=>e.toJSON())})}catch(e){console.log(e)}finally{console.log("got product for admin")}}),app.get("/producten-overzicht/detail/:id",async(e,r)=>{try{var o=await Product.findById(e.params.id),s=[];s.push(o),r.render("product-detail",{product:s.map(e=>e.toJSON())})}catch(e){console.log(e)}finally{console.log("got product detail for user")}}),app.get("/producten-overzicht/toevoegen",async(e,r)=>{r.render("admin-addProducts")}),app.get("/voorkeuren",(e,r)=>{r.render("voorkeuren",{error:""})}),app.post("/voorkeuren",(e,r)=>{var{energielevel:o,leefstijl:s,grootte:a,slaapritme:n}=e.body,e=e.session.gebruikersnaam;User.findOneAndUpdate({gebruikersnaam:e},{voorkeuren:{energielevel:o,leefstijl:s,grootte:a,slaapritme:n}},{new:!0}).then(()=>{r.redirect("/products")}).catch(e=>{console.error("Error updating preferences:",e),r.render("voorkeuren",{error:"Error updating preferences"})})}),app.get("/voorkeuren-opgeslagen",async(e,r)=>{try{var o,s,a,n,t=e.session["gebruikersnaam"],i=await User.findOne({gebruikersnaam:t});i?({energielevel:o,leefstijl:s,grootte:a,slaapritme:n}=i.voorkeuren,console.log("Ingelogde gebruiker:",t),console.log("Energielevel:",o),console.log("Leefstijl:",s),console.log("Grootte:",a),console.log("Slaapritme:",n),r.render("voorkeuren-opgeslagen",{energielevel:o,leefstijl:s,grootte:a,slaapritme:n})):console.log("Gebruiker niet gevonden")}catch(e){console.error("Fout bij het ophalen van gebruikersgegevens:",e)}}),app.get("/confirm",async(e,r)=>{var o=new Date,s=new Date,a=(s.setDate(o.getDate()+7),new Date);for(a.setDate(a.getDate()+1),5===o.getDay()&&s.setDate(s.getDate()+7);0===s.getDay()||6===s.getDay();)s.setDate(s.getDate()+1);a=s.toISOString().split("T")[0];r.render("confirm",{weekdaysStr:a,doggo:{naam:"Barry",soort:"Golden retriever",leeftijd:"1",beschrijving:"Barry is een rustige hond die goed met kinderen om kan gaan. Hij houdt erg van buitenspelen en knuffelen."}})}),require("passport-google-oauth20").Strategy),GOOGLE_CLIENT_ID="593422950502-97fr9pua64objfd3htu6n4u4oa6i2usm.apps.googleusercontent.com",GOOGLE_CLIENT_SECRET="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";passport.use(new GoogleStrategy({clientID:GOOGLE_CLIENT_ID,clientSecret:GOOGLE_CLIENT_SECRET,callbackURL:"/auth/google/callback"},async(e,r,o,s)=>{try{var a=await User.findOne({googleId:o.id});s(null,a||await User.create({googleId:o.id,name:o.displayName,email:o.emails[0].value}))}catch(e){s(e,null)}})),app.use(passport.initialize()),app.use(passport.session()),passport.serializeUser((e,r)=>{r(null,e.id)}),passport.deserializeUser(async(e,r)=>{try{r(null,await User.findById(e))}catch(e){r(e,null)}}),app.get("/auth/google",passport.authenticate("google",{scope:["profile","email"]})),app.get("/auth/google/callback",passport.authenticate("google",{failureRedirect:"/login"}),(e,r)=>{r.redirect("/products")}),app.get("/wishlist",async(e,r)=>{try{var o=await User.find({gebruikersnaam:e.session.gebruikersnaam});if(!o)throw new Error("User not found");var s=o[0].wishlist,a=(console.log(s),await Product.find({_id:{$in:s}}));console.log(a),r.render("wishlist",{wishlist:a.map(e=>e.toJSON())})}catch(e){throw console.error("Error retrieving wishlist products:",e),e}}),app.post("/wishlist-add/:id",async(e,r)=>{try{var o=await User.findOneAndUpdate({gebruikersnaam:e.session.gebruikersnaam},{$push:{wishlist:e.params.id}});console.log(o),r.redirect("/products")}catch(e){console.error("Error adding movie to wishlist:",e),r.status(500).json({error:"Internal server error"})}}),app.get("*",(e,r)=>{r.status(404).render("notfound")}),app.listen(PORT,()=>{console.log("server running on port: "+PORT)});